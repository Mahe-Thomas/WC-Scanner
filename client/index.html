<!DOCTYPE html>
<html>

    <head>
        <title>WebSocket demo</title>


        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="node_modules/bootstrap-material-design/dist/css/bootstrap-material-design.min.css">
        <link rel="stylesheet" href="node_modules/material-design-icons-iconfont/dist/material-design-icons.css">

        <!-- Bootstrap Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script>window.$ = window.jQuery = require('jquery');</script>
        <script>window.Popper = require('popper.js');</script>
        <script>
            require('bootstrap-material-design');
        </script>

    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" onclick="drawHomeContent()" href="#">WCScanner</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li id="menu_home" class="nav-item active">
                        <a class="nav-link"  onclick="drawHomeContent()" href="#">Home</a>
                    </li>
                    <li id="menu_project" class="nav-item">
                        <a class="nav-link"   onclick="drawProjectContent()" href="#">Project</a>
                    </li>
                    <li id="menu_control" class="nav-item">
                        <a class="nav-link" onclick="drawControlContent()" href="#">Control</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <div id="content" class="pt-2">
                <p type="online">Offline</p>
            </div>
        </div>
        <script>
            var users, websocket;
            var projects_data;

            var retry = 0;

            function get_connection_status() {
                if (websocket.readyState === websocket.CLOSED) {
                    websocket = new WebSocket("ws://localhost:6789/");
                    websocket.onclose = function() {
                        updateConnectionStatus();
                    };
                    websocket.onopen = function() {
                        updateConnectionStatus()
                    };
                    retry += 1;
                }
                if (retry > 10) {
                    require('electron').remote.getCurrentWindow().close();
                }
            }

            $(document).ready(function() {
                $('#content').load("./core/home.html");

                //websocket = new WebSocket("ws://localhost:6789/");

                /**
                 * RPi address
                 */
                websocket = new WebSocket("ws://localhost:6789/");

                setInterval(get_connection_status, 1000);

                drawHomeContent();

                websocket.onclose = function() {
                    drawHomeContent();
                };
                websocket.onopen = function() {
                    drawHomeContent()
                };

                websocket.onmessage = function(event) {
                    data = JSON.parse(event.data);
                    console.log(data);
                    switch (data.type) {
                        case 'users':
                            //document.getElementById('users').innerText = data.count.toString() + " user" + (data.count > 1 ? "s" : "");
                            break;
                        case 'state':
                            //@TODO capter les changements dans les variables du scanner
                            break;
                        case 'projects_data':
                            console.log(data.data);
                            projects_data = data.data;
                            if (document.getElementById('menu_project').classList.contains('active')){
                                drawProjectContent();
                            }
                            break;
                        default:
                            console.error(
                                "unsupported event", data);
                    }
                };
            });

            function updateConnectionStatus() {
                if (websocket.readyState === websocket.CLOSED) {
                    document.getElementById('content').innerHTML = '<style>\n' +
                        '    p[type=online] {\n' +
                        '        background-color: #b30006;\n' +
                        '        border: none;\n' +
                        '        border-radius: 12px;\n' +
                        '        color: white;\n' +
                        '        padding: 16px 16px;\n' +
                        '        text-decoration: none;\n' +
                        '        margin: 4px 10px;\n' +
                        '        text-align: center;\n' +
                        '        font-size: 250%;\n' +
                        '        font-family: "Arial Black";\n' +
                        '    }\n' +
                        '</style>\n' +
                        '<div class="state" id="on">\n' +
                        '    <p type="online">OFFLINE</p>\n' +
                        '</div>';
                } else {
                    var fs = require("fs");
                    var text = fs.readFileSync("./core/home.html");
                    document.getElementById('content').innerHTML = '<style>\n' +
                        '    p[type=online] {\n' +
                        '        background-color: #00b321;\n' +
                        '        border: none;\n' +
                        '        border-radius: 12px;\n' +
                        '        color: white;\n' +
                        '        padding: 16px 16px;\n' +
                        '        text-decoration: none;\n' +
                        '        margin: 4px 10px;\n' +
                        '        text-align: center;\n' +
                        '        font-size: 250%;\n' +
                        '        font-family: "Arial Black";\n' +
                        '    }\n' +
                        '</style>\n' +
                        '<div class="state" id="on">\n' +
                        '    <p type="online">ONLINE</p>\n' +
                        '</div>';
                }
            }

            function drawHomeContent() {
                var fs = require("fs");
                var text = fs.readFileSync("./core/home.html");
                document.getElementById('content').innerHTML = text;

                document.getElementById('menu_home').classList.add("active");
                document.getElementById('menu_project').classList.remove("active");
                document.getElementById('menu_control').classList.remove("active");
            }

            function drawControlContent() {
                var fs = require("fs");
                var text = fs.readFileSync("./core/control.html");
                document.getElementById('content').innerHTML = text;

                document.getElementById('menu_home').classList.remove("active");
                document.getElementById('menu_project').classList.remove("active");
                document.getElementById('menu_control').classList.add("active");
            }

            function drawProjectContent() {

                document.getElementById('menu_home').classList.remove("active");
                document.getElementById('menu_project').classList.add("active");
                document.getElementById('menu_control').classList.remove("active");

                let projects_html = "";
                projects_data.forEach(function(element) {
                    projects_html += generate_project_html_element(JSON.parse(element));
                });

                var fs = require("fs");
                var content = fs.readFileSync("./core/project.html") + "";
                content = content.replace("{{PROJECT_PLACEHOLDER}}", projects_html);
                document.getElementById('content').innerHTML = content;

                $("#search_input").on("keyup", function() {
                    var value = $(this).val().toLowerCase();
                    $("#projects .col-md-4").filter(function() {
                        console.log($(this).text());
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                    });
                });

            }

            function generate_project_html_element(project_data) {
                return "<div class=\"col-md-4\" id='"+project_data["name"]+"'>\n" +
                "            <div class=\"card mb-4 box-shadow\">\n" +
                "                <img class=\"card-img-top\" data-src=\"holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=Thumbnail\" alt=\"Thumbnail [100%x225]\" style=\"height: 225px; width: 100%; display: block;\" src=\"data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22350%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20350%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16b064f20ca%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A18pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16b064f20ca%22%3E%3Crect%20width%3D%22350%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22113.5%22%20y%3D%22120.9%22%3EThumbnail%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E\" data-holder-rendered=\"true\">\n" +
                "                <div class=\"card-body\">\n" +
                "                    <h5 className=\"card-title\">"+ project_data["name"] + "</h5>\n" +
                "                    <p class=\"card-text\">"+ project_data["description"] + "</p>\n" +
                "                    <p class=\"card-text\">Pictures per revolution : "+ project_data["pict_per_rotation"] + "</p>\n" +
                "                    <p class=\"card-text\">Pictures resolution : "+ project_data["pict_res"] + "</p>\n" +
                "                    <div class=\"d-flex justify-content-between align-items-center\">\n" +
                "                        <div class=\"btn-group\">\n" +
                "                            <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\">View</button>\n" +
                "                            <button type=\"button\" class=\"btn btn-sm btn-outline-secondary\">Edit</button>\n" +
                "                        </div>\n" +
                "                        <small class=\"text-muted\">0 Mb</small>\n" +
                        //@TODO project size
                "                    </div>\n" +
                "                </div>\n" +
                "            </div>\n" +
                "        </div>"
            }



            /**
             * Turn bed clockwise
             */
            function turn_bed_CW_trigger() {
                let angle = document.getElementById("turn_bed_value").value;
                websocket.send(JSON.stringify({
                    action: "turn_bed_CW",
                    plateau_degree: angle.toString()
                }))
            }

            function turn_bed_CCW_trigger() {
                let angle = document.getElementById("turn_bed_value").value;
                websocket.send(JSON.stringify({
                    action: "turn_bed_CCW",
                    plateau_degree: angle.toString()
                }))
            }

            /**
             * create project
             */

            function create_project() {
                let project_name = document.getElementById("project_name").value;
                websocket.send(JSON.stringify({
                    action: "create_project",
                    project_name: project_name
                }))
            }

            function update_ppr_placeholder() {
                document.getElementById("ppr_placeholder").innerHTML = document.getElementById("project_ppr").value;
                updateEstimatedSize();
            }

            function update_pres_placeholder(value) {
                console.log(value * 10);
                let new_placeholder;
                switch (value + "") {
                    case "1" :
                        new_placeholder = "640x480";
                        break;
                    case "2" :
                        new_placeholder = "1640x1232";
                        break;
                    case "3" :
                        new_placeholder = "3280x2464";
                        break;
                    default :
                        new_placeholder = "None"
                }

                console.log(new_placeholder);
                
                document.getElementById("pres_placeholder").innerHTML = new_placeholder;
                updateEstimatedSize()
            }

            function updateEstimatedSize(){

                let new_placeholder = "Estimated size : ";

                let picture_res = document.getElementById("project_pres").value;
                let total_pictures = 3 * document.getElementById("project_ppr").value;

                let picture_size;
                // in KB
                switch (picture_res + "") {
                    case "1" :
                        picture_size = 62;
                        break;
                    case "2" :
                        picture_size = 413;
                        break;
                    case "3" :
                        picture_size = 1650;
                        break;
                    default :
                        picture_size = 0
                }

                total_size = (picture_size * total_pictures) / 1000;

                document.getElementById("estimated_size_placeholder").innerHTML = new_placeholder + total_size.toFixed(2) + "Mb / complete rotation";
            }

        </script>
    </body>
</html>