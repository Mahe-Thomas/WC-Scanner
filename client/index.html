<!DOCTYPE html>
<html>

    <head>
        <title>WebSocket demo</title>


        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="node_modules/bootstrap-material-design/dist/css/bootstrap-material-design.min.css">
        <link rel="stylesheet" href="node_modules/material-design-icons-iconfont/dist/material-design-icons.css">

        <!-- Bootstrap Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script>window.$ = window.jQuery = require('jquery');</script>
        <script>window.Popper = require('popper.js');</script>
        <script>
            require('bootstrap-material-design');
        </script>

    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" onclick="drawHomeContent()" href="#">WCScanner</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li id="menu_home" class="nav-item active">
                        <a class="nav-link"  onclick="drawHomeContent()" href="#">Home</a>
                    </li>
                    <li id="menu_project" class="nav-item">
                        <a class="nav-link"   onclick="drawProjectContent()" href="#">Project</a>
                    </li>
                    <li id="menu_control" class="nav-item">
                        <a class="nav-link" onclick="drawControlContent()" href="#">Control</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <div id="content" class="pt-2">
                <p type="online">Offline</p>
            </div>
        </div>
        <script>
            var users, websocket;

            var retry = 0;

            function get_connection_status() {
                if (websocket.readyState === websocket.CLOSED) {
                    websocket = new WebSocket("ws://localhost:6789/");
                    websocket.onclose = function() {
                        updateConnectionStatus();
                    };
                    websocket.onopen = function() {
                        updateConnectionStatus()
                    };
                    retry += 1;
                }
                if (retry > 10) {
                    require('electron').remote.getCurrentWindow().close();
                }
            }

            $(document).ready(function() {
                $('#content').load("./core/home.html");

                //websocket = new WebSocket("ws://localhost:6789/");

                /**
                 * RPi address
                 */
                websocket = new WebSocket("ws://localhost:6789/");

                setInterval(get_connection_status, 1000);

                drawHomeContent();

                websocket.onclose = function() {
                    drawHomeContent();
                };
                websocket.onopen = function() {
                    drawHomeContent()
                };

                websocket.onmessage = function(event) {
                    data = JSON.parse(event.data);
                    console.log(data);
                    switch (data.type) {
                        case 'users':
                            //document.getElementById('users').innerText = data.count.toString() + " user" + (data.count > 1 ? "s" : "");
                            break;
                        case 'state':
                            //@TODO capter les changements dans les variables du scanner
                            break;
                        default:
                            console.error(
                                "unsupported event", data);
                    }
                };
            });

            function updateConnectionStatus() {
                if (websocket.readyState === websocket.CLOSED) {
                    document.getElementById('content').innerHTML = '<style>\n' +
                        '    p[type=online] {\n' +
                        '        background-color: #b30006;\n' +
                        '        border: none;\n' +
                        '        border-radius: 12px;\n' +
                        '        color: white;\n' +
                        '        padding: 16px 16px;\n' +
                        '        text-decoration: none;\n' +
                        '        margin: 4px 10px;\n' +
                        '        text-align: center;\n' +
                        '        font-size: 250%;\n' +
                        '        font-family: "Arial Black";\n' +
                        '    }\n' +
                        '</style>\n' +
                        '<div class="state" id="on">\n' +
                        '    <p type="online">OFFLINE</p>\n' +
                        '</div>';
                } else {
                    var fs = require("fs");
                    var text = fs.readFileSync("./core/home.html");
                    document.getElementById('content').innerHTML = '<style>\n' +
                        '    p[type=online] {\n' +
                        '        background-color: #00b321;\n' +
                        '        border: none;\n' +
                        '        border-radius: 12px;\n' +
                        '        color: white;\n' +
                        '        padding: 16px 16px;\n' +
                        '        text-decoration: none;\n' +
                        '        margin: 4px 10px;\n' +
                        '        text-align: center;\n' +
                        '        font-size: 250%;\n' +
                        '        font-family: "Arial Black";\n' +
                        '    }\n' +
                        '</style>\n' +
                        '<div class="state" id="on">\n' +
                        '    <p type="online">ONLINE</p>\n' +
                        '</div>';
                }
            }

            function drawHomeContent() {
                var fs = require("fs");
                var text = fs.readFileSync("./core/home.html");
                document.getElementById('content').innerHTML = text;

                document.getElementById('menu_home').classList.add("active");
                document.getElementById('menu_project').classList.remove("active");
                document.getElementById('menu_control').classList.remove("active");
            }

            function drawControlContent() {
                var fs = require("fs");
                var text = fs.readFileSync("./core/control.html");
                document.getElementById('content').innerHTML = text;

                document.getElementById('menu_home').classList.remove("active");
                document.getElementById('menu_project').classList.remove("active");
                document.getElementById('menu_control').classList.add("active");
            }

            function drawProjectContent() {
                var fs = require("fs");
                var text = fs.readFileSync("./core/project.html");
                document.getElementById('content').innerHTML = text;

                document.getElementById('menu_home').classList.remove("active");
                document.getElementById('menu_project').classList.add("active");
                document.getElementById('menu_control').classList.remove("active");
            }

            /**
             * Turn bed clockwise
             */
            function turn_bed_CW_trigger() {
                let angle = document.getElementById("turn_bed_value").value;
                websocket.send(JSON.stringify({
                    action: "turn_bed_CW",
                    plateau_degree: angle.toString()
                }))
            }

            function turn_bed_CCW_trigger() {
                let angle = document.getElementById("turn_bed_value").value;
                websocket.send(JSON.stringify({
                    action: "turn_bed_CCW",
                    plateau_degree: angle.toString()
                }))
            }

            /**
             * create project
             */

            function create_project() {
                let project_name = document.getElementById("project_name").value;
                websocket.send(JSON.stringify({
                    action: "create_project",
                    project_name: project_name
                }))
            }

            function update_ppr_placeholder() {
                document.getElementById("ppr_placeholder").innerHTML = document.getElementById("project_ppr").value;
                updateEstimatedSize();
            }

            function update_pres_placeholder(value) {
                console.log(value * 10);
                let new_placeholder;
                switch (value + "") {
                    case "1" :
                        new_placeholder = "640x480";
                        break;
                    case "2" :
                        new_placeholder = "1640x1232";
                        break;
                    case "3" :
                        new_placeholder = "3280x2464";
                        break;
                    default :
                        new_placeholder = "None"
                }

                console.log(new_placeholder);
                
                document.getElementById("pres_placeholder").innerHTML = new_placeholder;
                updateEstimatedSize()
            }

            function updateEstimatedSize(){

                let new_placeholder = "Estimated size : ";

                let picture_res = document.getElementById("project_pres").value;
                let total_pictures = 3 * document.getElementById("project_ppr").value;

                let picture_size;
                // in KB
                switch (picture_res + "") {
                    case "1" :
                        picture_size = 62;
                        break;
                    case "2" :
                        picture_size = 413;
                        break;
                    case "3" :
                        picture_size = 1650;
                        break;
                    default :
                        picture_size = 0
                }

                total_size = (picture_size * total_pictures) / 1000;

                document.getElementById("estimated_size_placeholder").innerHTML = new_placeholder + total_size.toFixed(2) + "Mb / complete rotation";
            }


        </script>
    </body>
</html>